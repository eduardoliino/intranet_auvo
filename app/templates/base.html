<!DOCTYPE html>
<html lang="pt-br" class="h-100">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Intranet Auvo</title>

    <link
      rel="icon"
      href="{{ url_for('static', filename='img/logo_icon.svg') }}"
      type="image/svg+xml"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="{{ url_for('static', filename='js/reactions-ui.js') }}" defer></script>
  </head>

  <body x-data="globalUtils()">
    <nav class="navbar navbar-auvo fixed-top">
      <div class="container-fluid">
        <div class="d-flex align-items-center">
          <button
            class="d-lg-none btn me-2"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#mobileSidebar"
            aria-controls="mobileSidebar"
          >
            <i class="bi bi-list fs-3"></i>
          </button>
          <a class="navbar-brand" href="{{ url_for('main.index') }}">
            <img
              src="{{ url_for('static', filename='img/logo.png') }}"
              alt="Intranet Auvo Logo"
            />
          </a>
        </div>

        <div
          x-data="counterAnimation()"
          class="totalizador-pill-nav d-none d-lg-flex"
        >
          <span>Já somos </span>
          <span
            x-text="count"
            class="mx-1 fw-bold"
            style="display: inline-block; min-width: 35px; text-align: center"
          ></span>
          <span>Auvolovers</span>
          <i class="bi bi-heart-fill ms-2"></i>
        </div>

        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center">
            <span class="d-none d-md-inline me-2">
              Boas-vindas,
              <strong class="fw-bold">{{ current_user.nome }}</strong>
            </span>

            {% if current_user.foto_filename %}
            <img
              src="{{ url_for('static', filename='fotos_colaboradores/' + current_user.foto_filename) }}"
              class="perfil-avatar"
              alt="Foto de Perfil"
            />
            {% else %}
            <div
              class="colaborador-avatar-tabela perfil-avatar"
              :style="`background-color: ${getAvatarColor('{{ current_user.nome }}')}`"
            >
              <span
                x-text="getInitials('{{ current_user.nome }}', '{{ current_user.sobrenome }}')"
              ></span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <div x-data="notificationHandler" @ouvidoria-updated.window="checkStatus()">
      <div class="sidebar-auvo d-none d-lg-flex flex-column">
        <div class="sidebar-content">
          <h6 class="sidebar-title">Navegação</h6>
          <div class="list-group list-group-flush">
            <a href="{{ url_for('main.index') }}" class="list-group-item"
              ><i class="bi bi-house-door-fill"></i> Início</a
            >
            <a href="{{ url_for('main.ouvidoria') }}" class="list-group-item"
              ><i class="bi bi-ear-fill"></i> Ouvidoria</a
            >
            <a href="{{ url_for('main.faq_publico') }}" class="list-group-item"
              ><i class="bi bi-patch-question-fill"></i> FAQ</a
            >
            <a
              href="{{ url_for('main.ver_organograma') }}"
              class="list-group-item"
              ><i class="bi bi-diagram-3-fill"></i> Organograma</a
            >
            <a href="{{ url_for('newsletter.feed') }}" class="list-group-item"
              ><i class="bi bi-newspaper"></i> Auvo News</a
            >
          </div>

          {% if current_user.is_admin or current_user.permissoes %}
          <hr class="sidebar-divider" />
          <h6 class="sidebar-title">Administração</h6>
          <div class="list-group list-group-flush">
            {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_colaboradores') %}
            <a
              href="{{ url_for('colaborador.listar') }}"
              class="list-group-item"
              ><i class="bi bi-people-fill"></i> Colaboradores</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_avisos') %}
            <a
              href="{{ url_for('admin.gerenciar_avisos') }}"
              class="list-group-item"
              ><i class="bi bi-megaphone-fill"></i> Avisos</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_destaques') %}
            <a
              href="{{ url_for('admin.gerenciar_destaques') }}"
              class="list-group-item"
              ><i class="bi bi-star-fill"></i> Destaques</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_faq') %}
            <a
              href="{{ url_for('admin.gerenciar_faq') }}"
              class="list-group-item"
              ><i class="bi bi-patch-question-fill"></i> Perguntas</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_ouvidoria') %}
            <a
              href="{{ url_for('admin.gerenciar_ouvidoria') }}"
              class="list-group-item"
              ><i class="bi bi-ear-fill"></i> Mensagens<span
                x-show="hasNewOuvidoria"
                class="notification-dot"
                x-cloak
              ></span
            ></a>
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_eventos') %}
            <a
              href="{{ url_for('admin.gerenciar_eventos') }}"
              class="list-group-item"
              ><i class="bi bi-calendar-event-fill"></i> Eventos</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_links') %}
            <a
              href="{{ url_for('admin.gerenciar_links') }}"
              class="list-group-item"
              ><i class="bi bi-link-45deg"></i> Links</a
            >
            {% endif %} {% if current_user.is_admin %}
            <a
              href="{{ url_for('newsletter.admin_page') }}"
              class="list-group-item"
              ><i class="bi bi-newspaper"></i> Auvo News</a
            >
            <a
              href="/admin/sentimento"
              class="list-group-item"
              ><i class="bi bi-emoji-smile"></i> Sentimento do Dia</a>
            {% endif %}
          </div>
          {% endif %}
        </div>
        <div class="sidebar-footer">
          <a
            href="{{ url_for('auth.logout') }}"
            class="list-group-item list-group-item-logout"
            ><i class="bi bi-box-arrow-right"></i> Sair do Sistema</a
          >
        </div>
      </div>

      <div
        class="offcanvas offcanvas-start offcanvas-auvo d-lg-none"
        tabindex="-1"
        id="mobileSidebar"
        aria-labelledby="mobileSidebarLabel"
      >
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="mobileSidebarLabel">Navegação</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
          ></button>
        </div>
        <div class="offcanvas-body p-0">
          <div class="list-group list-group-flush">
            <a href="{{ url_for('main.index') }}" class="list-group-item"
              ><i class="bi bi-house-door-fill"></i> Início</a
            >
            <a href="{{ url_for('main.ouvidoria') }}" class="list-group-item"
              ><i class="bi bi-ear-fill"></i> Ouvidoria</a
            >
            <a href="{{ url_for('main.faq_publico') }}" class="list-group-item"
              ><i class="bi bi-patch-question-fill"></i> FAQ</a
            >
            <a
              href="{{ url_for('main.ver_organograma') }}"
              class="list-group-item"
              ><i class="bi bi-diagram-3-fill"></i> Organograma</a
            >
            <a href="{{ url_for('newsletter.feed') }}" class="list-group-item"
              ><i class="bi bi-newspaper"></i> Auvo News</a
            >
          </div>
          {% if current_user.is_admin or current_user.permissoes %}
          <hr class="mx-3" style="color: rgba(255, 255, 255, 0.3)" />
          <div class="list-group list-group-flush">
            {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_colaboradores') %}
            <a
              href="{{ url_for('colaborador.listar') }}"
              class="list-group-item"
              ><i class="bi bi-people-fill"></i> Gerir Colaboradores</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_avisos') %}
            <a
              href="{{ url_for('admin.gerenciar_avisos') }}"
              class="list-group-item"
              ><i class="bi bi-megaphone-fill"></i> Gerir Avisos</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_destaques') %}
            <a
              href="{{ url_for('admin.gerenciar_destaques') }}"
              class="list-group-item"
              ><i class="bi bi-star-fill"></i> Gerir Destaques</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_faq') %}
            <a
              href="{{ url_for('admin.gerenciar_faq') }}"
              class="list-group-item"
              ><i class="bi bi-patch-question-fill"></i> Perguntas</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_ouvidoria') %}
            <a
              href="{{ url_for('admin.gerenciar_ouvidoria') }}"
              class="list-group-item"
              ><i class="bi bi-ear-fill"></i> Mensagens<span
                x-show="hasNewOuvidoria"
                class="notification-dot"
                x-cloak
              ></span
            ></a>
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_eventos') %}
            <a
              href="{{ url_for('admin.gerenciar_eventos') }}"
              class="list-group-item"
              ><i class="bi bi-calendar-event-fill"></i> Gerir Eventos</a
            >
            {% endif %} {% if current_user.is_admin or
            current_user.tem_permissao('gerenciar_links') %}
            <a
              href="{{ url_for('admin.gerenciar_links') }}"
              class="list-group-item"
              ><i class="bi bi-link-45deg"></i> Gerir Links</a
            >
            {% endif %} {% if current_user.is_admin %}
            <a
              href="{{ url_for('newsletter.admin_page') }}"
              class="list-group-item"
              ><i class="bi bi-newspaper"></i> Auvo News</a
            >
            {% endif %}
          </div>
          {% endif %}
          <hr class="mx-3" style="color: rgba(255, 255, 255, 0.3)" />
          <a href="{{ url_for('auth.logout') }}" class="list-group-item"
            ><i class="bi bi-box-arrow-right"></i> Sair do Sistema</a
          >
        </div>
      </div>
    </div>

    <main id="content">{% block content %}{% endblock %}</main>

    <div
      x-data="toastHandler()"
      class="position-fixed top-0 end-0 p-3"
      style="z-index: 1100; margin-top: 60px"
      @toast.window="addToast($event.detail)"
    >
      <template x-for="toast in toasts" :key="toast.id">
        <div
          class="toast show mb-2"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
          x-show="toast.visible"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 transform translate-x-8"
          x-transition:enter-end="opacity-100 transform translate-x-0"
          x-transition:leave="transition ease-in duration-300"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
        >
          <div
            class="toast-header"
            :class="{
                    'bg-success text-white': toast.type === 'success',
                    'bg-danger text-white': toast.type === 'danger',
                    'bg-warning text-dark': toast.type === 'warning',
                    'bg-info text-white': toast.type === 'info'
                }"
          >
            <strong class="me-auto" x-text="toast.title"></strong>
            <button
              type="button"
              class="btn-close btn-close-white"
              @click="removeToast(toast.id)"
            ></button>
          </div>
          <div class="toast-body" x-text="toast.message"></div>
        </div>
      </template>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js"></script>

    <script>
      document.addEventListener('alpine:init', () => {
          Alpine.data('counterAnimation', () => ({
              count: 0,
              totalColaboradores: {{ total_colaboradores or 0 }},
              init() {
                  if (this.totalColaboradores <= 0) return;
                  let step = Math.max(1, Math.ceil(this.totalColaboradores / 100));
                  let current = 0;
                  let timer = setInterval(() => {
                      current += step;
                      if (current >= this.totalColaboradores) {
                          current = this.totalColaboradores;
                          clearInterval(timer);
                      }
                      this.count = Math.floor(current);
                  }, 15);
              }
          }));

          Alpine.data('globalUtils', () => ({
              getInitials(nome, sobrenome) {
                  return `${nome ? nome.charAt(0) : ''}${sobrenome ? sobrenome.charAt(0) : ''}`.toUpperCase();
              },
              getAvatarColor(nome) {
                  const colors = ['#C051FF', '#7A28B8', '#3A1B4A', '#00D29D', '#345978'];
                  let hash = 0;
                  if (!nome || nome.length === 0) return colors[0];
                  for (let i = 0; i < nome.length; i++) {
                      hash = nome.charCodeAt(i) + ((hash << 5) - hash);
                  }
                  return colors[Math.abs(hash % colors.length)];
              }
          }));

          Alpine.data('notificationHandler', () => ({
              hasNewOuvidoria: {{ tem_nova_ouvidoria|tojson|safe }},

              init() {
                  setInterval(() => {
                      this.checkStatus();
                  }, 60000);
              },

              async checkStatus() {
                  try {
                      const response = await fetch("{{ url_for('main.api_ouvidoria_status') }}");
                      if (!response.ok) return;

                      const data = await response.json();
                      this.hasNewOuvidoria = data.has_new;
                  } catch (error) {
                      console.error('Error checking notification status:', error);
                  }
              }
          }));
      });
    </script>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script async src="//www.instagram.com/embed.js"></script>
    {% block page_scripts %}{% endblock %}

    <script>
      function toastHandler() {
          return {
              toasts: [],
              counter: 0,
              addToast(toast) {
                  const id = this.counter++;
                  const titles = {
                      success: 'Sucesso!',
                      danger: 'Erro!',
                      warning: 'Atenção!',
                      info: 'Informação'
                  };
                  this.toasts.push({
                      id: id,
                      type: toast.type || 'info',
                      title: titles[toast.type] || 'Notificação',
                      message: toast.message,
                      visible: true
                  });
                  setTimeout(() => {
                      this.removeToast(id);
                  }, 5000);
              },
              removeToast(id) {
                  const toast = this.toasts.find(t => t.id === id);
                  if (toast) {
                      toast.visible = false;
                      setTimeout(() => {
                         this.toasts = this.toasts.filter(t => t.id !== id);
                      }, 400);
                  }
              }
          }
      }

      document.addEventListener('DOMContentLoaded', function() {
          var selects = document.querySelectorAll('select.custom-select');
          selects.forEach(function(select) {
              new TomSelect(select, {
                  plugins: ['clear_button']
              });
          });

          {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                  {% for category, message in messages %}
                      window.dispatchEvent(new CustomEvent('toast', { detail: { type: '{{ category }}', message: {{ message|tojson|safe }} }}));
                  {% endfor %}
              {% endif %}
          {% endwith %}

          var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
          var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl)
          });
      });

      document.body.addEventListener('htmx:afterSwap', function(event) {
          var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
          var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl)
          });
      });
    </script>
  </body>
</html>
