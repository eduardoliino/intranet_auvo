<!DOCTYPE html>
<html lang="pt-br" class="h-100">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Intranet Auvo</title>
    
    <link rel="icon" href="{{ url_for('static', filename='img/logo_icon.svg') }}" type="image/svg+xml">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-auvo fixed-top">
        <div class="container-fluid">
            <div class="d-flex align-items-center" id="menuPrincipalTrigger">
                <a class="navbar-brand" href="{{ url_for('main.index') }}" style="cursor: pointer;">
                    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Intranet Auvo Logo">
                </a>
            </div>

            <div x-data="counterAnimation()" class="totalizador-pill-nav d-none d-lg-flex">
                <span>Já somos </span>
                <span x-text="count" class="mx-1 fw-bold" style="min-width: 20px; text-align: center;"></span>
                <span>Auvolovers</span>
                <i class="bi bi-heart-fill ms-2" style="color: var(--auvo-lilas);"></i>
            </div>

            <div class="d-flex align-items-center gap-3">
                <a href="https://www.instagram.com/auvotalentos/" target="_blank" class="btn-instagram-nav d-none d-md-flex">
                    <i class="bi bi-instagram"></i>
                    <span>Auvo Talentos</span>
                </a>
                <div id="menuUsuarioTrigger" style="cursor: pointer;" class="d-flex align-items-center">
                    <span class="d-none d-md-inline me-2">
                        Boas-vindas, <strong class="fw-bold">{% if current_user.is_admin %}{{ current_user.username }}{% else %}{{ current_user.nome }}{% endif %}</strong>
                    </span>
                    {% set foto_perfil = 'img/default_avatar.png' %}
                    {% if not current_user.is_admin and current_user.foto_filename %}
                        {% set foto_perfil = 'fotos_colaboradores/' + current_user.foto_filename %}
                    {% endif %}
                    <img src="{{ url_for('static', filename=foto_perfil) }}" class="perfil-avatar" alt="Foto de Perfil">
                </div>
            </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start offcanvas-auvo" tabindex="-1" id="menuPrincipal" aria-labelledby="menuPrincipalLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="menuPrincipalLabel">Navegação</h5>
        </div>
        <div class="offcanvas-body p-0">
            <div class="list-group list-group-flush">
                <a href="{{ url_for('main.index') }}" class="list-group-item"><i class="bi bi-house-door-fill"></i> Início</a>
                <a href="{{ url_for('main.ouvidoria') }}" class="list-group-item"><i class="bi bi-ear-fill"></i> Ouvidoria</a>
                <a href="{{ url_for('main.faq_publico') }}" class="list-group-item"><i class="bi bi-patch-question-fill"></i> FAQ</a>
            </div>
        </div>
    </div>
    
    <div class="offcanvas offcanvas-end offcanvas-auvo" tabindex="-1" id="menuUsuario" aria-labelledby="menuUsuarioLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="menuUsuarioLabel">Opções de Usuário</h5>
        </div>
        <div class="offcanvas-body p-0">
             <div class="list-group list-group-flush">
                {% if current_user.is_admin %}
                    <a href="{{ url_for('admin.listar_colaboradores') }}" class="list-group-item"><i class="bi bi-people-fill"></i> Gerir Colaboradores</a>
                    <a href="{{ url_for('admin.gerenciar_avisos') }}" class="list-group-item"><i class="bi bi-megaphone-fill"></i> Gerir Avisos</a>
                    <a href="{{ url_for('admin.gerenciar_destaques') }}" class="list-group-item"><i class="bi bi-star-fill"></i> Gerir Destaques</a>
                    <a href="{{ url_for('admin.gerenciar_faq') }}" class="list-group-item"><i class="bi bi-patch-question-fill"></i> Gerir FAQ</a>
                    <a href="{{ url_for('admin.gerenciar_ouvidoria') }}" class="list-group-item"><i class="bi bi-ear-fill"></i> Gerir Ouvidoria</a>
                    <a href="{{ url_for('admin.gerenciar_eventos') }}" class="list-group-item"><i class="bi bi-calendar-event-fill"></i> Gerir Eventos</a>
                    <a href="{{ url_for('admin.gerenciar_links') }}" class="list-group-item"><i class="bi bi-link-45deg"></i> Gerir Links</a>
                    <hr class="mx-3" style="color: rgba(255,255,255,0.3);">
                {% endif %}
                <a href="{{ url_for('auth.logout') }}" class="list-group-item"><i class="bi bi-box-arrow-right"></i> Sair do Sistema</a>
            </div>
        </div>
    </div>


    <main id="content">
        {% block content %}{% endblock %}
    </main>

    <div 
        x-data="toastHandler()" 
        class="position-fixed top-0 end-0 p-3" 
        style="z-index: 1100; margin-top: 60px;"
        @toast.window="addToast($event.detail)"
    >
        <template x-for="toast in toasts" :key="toast.id">
            <div 
                class="toast show mb-2" 
                role="alert" 
                aria-live="assertive" 
                aria-atomic="true"
                x-show="toast.visible"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform translate-x-8"
                x-transition:enter-end="opacity-100 transform translate-x-0"
                x-transition:leave="transition ease-in duration-300"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
            >
                <div class="toast-header" :class="{
                    'bg-success text-white': toast.type === 'success',
                    'bg-danger text-white': toast.type === 'danger',
                    'bg-warning text-dark': toast.type === 'warning',
                    'bg-info text-white': toast.type === 'info'
                }">
                    <strong class="me-auto" x-text="toast.title"></strong>
                    <button type="button" class="btn-close btn-close-white" @click="removeToast(toast.id)"></button>
                </div>
                <div class="toast-body" x-text="toast.message"></div>
            </div>
        </template>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js"></script>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('counterAnimation', () => ({
                count: 0,
                totalColaboradores: {{ total_colaboradores or 0 }},
                init() {
                    if (this.totalColaboradores <= 0) return;
                    let step = Math.max(1, Math.ceil(this.totalColaboradores / 100));
                    let current = 0;
                    let timer = setInterval(() => {
                        current += step;
                        if (current >= this.totalColaboradores) {
                            current = this.totalColaboradores;
                            clearInterval(timer);
                        }
                        this.count = Math.floor(current);
                    }, 15);
                }
            }));
        });
    </script>
    
    {% block page_scripts %}{% endblock %}

    <script>
        function toastHandler() {
            return {
                toasts: [],
                counter: 0,
                addToast(toast) {
                    const id = this.counter++;
                    const titles = {
                        success: 'Sucesso!',
                        danger: 'Erro!',
                        warning: 'Atenção!',
                        info: 'Informação'
                    };
                    this.toasts.push({
                        id: id,
                        type: toast.type || 'info',
                        title: titles[toast.type] || 'Notificação',
                        message: toast.message,
                        visible: true
                    });
                    setTimeout(() => {
                        this.removeToast(id);
                    }, 5000);
                },
                removeToast(id) {
                    const toast = this.toasts.find(t => t.id === id);
                    if (toast) {
                        toast.visible = false;
                        setTimeout(() => {
                           this.toasts = this.toasts.filter(t => t.id !== id);
                        }, 400);
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var selects = document.querySelectorAll('select.custom-select');
            selects.forEach(function(select) {
                new TomSelect(select, {});
            });

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        window.dispatchEvent(new CustomEvent('toast', { detail: { type: '{{ category }}', message: {{ message|tojson|safe }} }}));
                    {% endfor %}
                {% endif %}
            {% endwith %}

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            function setupHoverMenu(triggerId, menuId) {
                const triggerEl = document.getElementById(triggerId);
                const menuEl = document.getElementById(menuId);
                if (!triggerEl || !menuEl) return;

                const menu = new bootstrap.Offcanvas(menuEl);
                let timeoutId;

                function showMenu() {
                    clearTimeout(timeoutId);
                    if (!menu._isShown) {
                        menu.show();
                    }
                }

                function hideMenu() {
                    timeoutId = setTimeout(() => {
                        menu.hide();
                    }, 200);
                }

                [triggerEl, menuEl].forEach(el => {
                    el.addEventListener('mouseenter', showMenu);
                    el.addEventListener('mouseleave', hideMenu);
                });
            }

            setupHoverMenu('menuPrincipalTrigger', 'menuPrincipal');
            setupHoverMenu('menuUsuarioTrigger', 'menuUsuario');
        });
    </script>
</body>
</html>