{% extends 'base.html' %} {% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/newsletter.css') }}"
/>

<div class="nl-feed py-4" x-data="newsletterFeed()">
  <h1 class="mb-4">Newsletter</h1>

  {% if fixados_posts or fixados_enquetes %}
  <h4 class="mb-3 text-muted">Destaques</h4>
  <div class="row g-4 mb-5">
    {% for post in fixados_posts %}
    <div class="col-md-6">{% include 'partials/news_post_card.html' %}</div>
    {% endfor %} {% for enquete in fixados_enquetes %}
    <div class="col-md-6">{% include 'partials/news_enquete_card.html' %}</div>
    {% endfor %}
  </div>
  {% endif %}

  <h4 class="mb-3 text-muted">Feed</h4>
  <div class="row g-4">
    {% for post in feed_posts %}
    <div class="col-md-6">{% include 'partials/news_post_card.html' %}</div>
    {% endfor %} {% for enquete in feed_enquetes %}
    <div class="col-md-6">{% include 'partials/news_enquete_card.html' %}</div>
    {% endfor %} {% if not feed_posts and not feed_enquetes %}
    <p class="text-center text-muted">Nenhuma publicação no feed.</p>
    {% endif %}
  </div>

  <div
    x-show="isModalOpen"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="nl-modal-overlay"
    @click.self="closeModal()"
    @keydown.escape.window="closeModal()"
    x-cloak
  >
    <div
      x-show="isModalOpen"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-95"
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 scale-100"
      x-transition:leave-end="opacity-0 scale-95"
      class="nl-modal-dialog"
      role="dialog"
      aria-modal="true"
      :aria-labelledby="'modal-title-' + modalContent.postId"
    >
      <header class="nl-modal-header">
        <h2
          :id="'modal-title-' + modalContent.postId"
          class="nl-modal-title"
          x-text="modalContent.postTitle"
        ></h2>
        <button
          @click="closeModal()"
          class="nl-modal-close-btn"
          aria-label="Fechar modal"
        >
          &times;
        </button>
      </header>

      <div class="nl-modal-body" x-ref="modalBody">
        <div
          x-show="isLoading"
          class="embed-placeholder"
          :class="modalContent.embedRatio"
        ></div>
        <div x-show="!isLoading" x-html="modalContent.embedHtml"></div>
        <hr class="my-4" />

        <div class="d-flex align-items-center gap-2 flex-wrap mb-3">
          <template
            x-for="reactionType in reactionTypes"
            :key="reactionType.type"
          >
            <button
              :class="['nl-reaction-chip', { 'selected': modalContent.reactions.user_reaction === reactionType.type, 'zero-count': !(modalContent.reactions.counts[reactionType.type] > 0) }]"
              @click="toggleReaction(reactionType.type)"
            >
              <i class="bi" :class="reactionType.icon"></i>
              <span
                x-text="modalContent.reactions.counts[reactionType.type] || 0"
              ></span>
            </button>
          </template>
        </div>

        <h6>Comentários</h6>
        <div class="mb-4">
          <template x-for="comment in modalContent.comments" :key="comment.id">
            <div class="d-flex align-items-start my-3">
              <template x-if="comment.user_photo">
                <img
                  :src="comment.user_photo"
                  class="nl-avatar me-3"
                  :alt="'Foto de ' + comment.user_name"
                />
              </template>
              <template x-if="!comment.user_photo">
                <div
                  class="nl-avatar d-flex justify-content-center align-items-center bg-secondary text-white me-3 flex-shrink-0"
                >
                  <span x-text="comment.user_initials"></span>
                </div>
              </template>
              <div class="w-100">
                <strong x-text="comment.user_name"></strong>
                <p
                  class="mb-0"
                  style="white-space: pre-wrap; word-break: break-word"
                  x-text="comment.text"
                ></p>
              </div>
            </div>
          </template>
        </div>
      </div>

      <footer class="nl-modal-footer">
        <div class="input-group">
          <textarea
            x-model="newCommentText"
            rows="1"
            class="form-control"
            placeholder="Adicionar um comentário..."
            @keydown.enter.prevent.stop="handleCommentSubmit($event)"
            @input="autosizeTextarea($event.target)"
          ></textarea>
          <button class="btn btn-outline-secondary" @click="submitComment()">
            Enviar
          </button>
        </div>
      </footer>
    </div>
  </div>
</div>
{% endblock %} {% block page_scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  function newsletterFeed() {
    return {
      isModalOpen: false,
      isLoading: true,
      newCommentText: "",
      isEnqueteModalOpen: false, // Nova propriedade para o modal de enquete
      enqueteContent: "", // Para guardar o HTML da enquete
      modalContent: {
        postId: null,
        postTitle: "Carregando...",
        embedHtml: "",
        embedRatio: "aspect-video",
        reactions: { counts: {}, user_reaction: null },
        comments: [],
      },
      reactionTypes: [
        { type: "heart", icon: "bi-heart-fill" },
        { type: "lightbulb", icon: "bi-lightbulb-fill" },
        { type: "rocket", icon: "bi-rocket-takeoff-fill" },
        { type: "grin", icon: "bi-emoji-grin-fill" },
        { type: "hearteyes", icon: "bi-emoji-heart-eyes-fill" },
        { type: "surprise", icon: "bi-emoji-surprise-fill" },
      ],
      lastTrigger: null,
      socket: null,

      init() {
        this.socket = io();
        this.socket.on("connect", () => {
          console.log("Socket.IO Conectado!");
        });

        this.socket.on("update_reactions", (data) => {
          if (this.isModalOpen && this.modalContent.postId === data.post_id) {
            this.modalContent.reactions.counts = data.counts;
          }
        });

        this.socket.on("new_comment", (data) => {
          // CORRIGIDO: A verificação deve usar data.post_id, que é enviado pelo backend no nível raiz do evento.
          if (this.isModalOpen && this.modalContent.postId === data.post_id) {
            if (
              !this.modalContent.comments.some((c) => c.id === data.comment.id)
            ) {
              this.modalContent.comments.push(data.comment);
              this.$nextTick(() => {
                this.$refs.modalBody.scrollTop =
                  this.$refs.modalBody.scrollHeight;
              });
            }
          }
        });
      },

      openModal(event, postId, postUrl) {
        if (!postUrl) {
          return;
        }
        this.lastTrigger = event.currentTarget;
        document.body.style.overflow = "hidden";
        this.isModalOpen = true;
        this.isLoading = true;

        fetch(
          `/api/news/post_details?url=${encodeURIComponent(
            postUrl
          )}&post_id=${postId}`
        )
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              this.modalContent = data;
              this.$nextTick(() => {
                const iframe = document.querySelector(
                  ".nl-modal-dialog iframe"
                );
                if (iframe) {
                  iframe.onload = () => {
                    this.isLoading = false;
                  };
                  setTimeout(() => {
                    this.isLoading = false;
                  }, 1500);
                } else {
                  this.isLoading = false;
                }
                if (window.instgrm) window.instgrm.Embeds.process();
              });
            } else {
              this.isLoading = false;
              this.modalContent.embedHtml = `<p class="text-danger text-center">${data.error}</p>`;
            }
          });
      },

      closeModal() {
        this.isModalOpen = false;
        document.body.style.overflow = "";
        if (this.lastTrigger) this.lastTrigger.focus();
        this.modalContent = {
          postId: null,
          postTitle: "Carregando...",
          embedHtml: "",
          embedRatio: "aspect-video",
          reactions: { counts: {}, user_reaction: null },
          comments: [],
        };
      },

      // --- NOVA FUNÇÃO ADICIONADA ---
      async openEnqueteModal(event, enqueteId) {
        this.lastTrigger = event.currentTarget;
        this.isLoading = true;
        this.isModalOpen = true; // Reutiliza o mesmo modal
        document.body.style.overflow = "hidden";

        // Limpa o conteúdo de post para evitar mostrar reações/comentários antigos
        this.modalContent.reactions = { counts: {}, user_reaction: null };
        this.modalContent.comments = [];

        const response = await fetch(`/newsletter/enquete/${enqueteId}`);
        if (response.ok) {
          const html = await response.text();
          this.modalContent.postTitle = "Enquete"; // Título genérico
          this.modalContent.embedHtml = html;
        } else {
          this.modalContent.postTitle = "Erro";
          this.modalContent.embedHtml = `<p class="text-center text-danger">Não foi possível carregar a enquete.</p>`;
        }
        this.isLoading = false; // Garante que o loading termine
      },

      async toggleReaction(type) {
        const postId = this.modalContent.postId;
        const currentReaction = this.modalContent.reactions.user_reaction;

        // Lógica otimista para feedback imediato
        if (currentReaction === type) {
          this.modalContent.reactions.user_reaction = null;
          this.modalContent.reactions.counts[type]--;
        } else {
          if (currentReaction) {
            this.modalContent.reactions.counts[currentReaction]--;
          }
          this.modalContent.reactions.user_reaction = type;
          this.modalContent.reactions.counts[type] =
            (this.modalContent.reactions.counts[type] || 0) + 1;
        }

        await fetch(`/api/news/post/${postId}/reacao`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tipo: type }),
        });
      },

      handleCommentSubmit(event) {
        if (!event.shiftKey) this.submitComment();
      },
      autosizeTextarea(el) {
        el.style.height = "auto";
        el.style.height = el.scrollHeight + "px";
      },

      async submitComment() {
        const text = this.newCommentText.trim();
        if (!text) return;

        const response = await fetch(
          `/api/news/post/${this.modalContent.postId}/comentarios`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ texto: text }),
          }
        );

        if (response.ok) {
          // CORRIGIDO: Remove a atualização otimista. O novo comentário será adicionado
          // de forma confiável pelo evento 'new_comment' do WebSocket para todos os usuários,
          // incluindo quem enviou, garantindo uma única fonte de verdade.
          this.newCommentText = "";
          this.$nextTick(() => {
            const input = document.querySelector(".nl-modal-dialog textarea");
            this.autosizeTextarea(input);
          });
        } else {
          alert("Erro ao enviar comentário.");
        }
      },
    };
  }
</script>
{% endblock %}
