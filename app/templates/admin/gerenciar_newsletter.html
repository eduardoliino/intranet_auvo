{% extends 'base.html' %} {% block content %}
<div class="container p-4" x-data="gerenciarNewsletter()">
  <h1 class="mb-4">Admin Newsletter</h1>

  <div class="card mb-4">
    <div
      class="card-header fw-bold"
      x-text="editPost.id ? 'Editar Post' : 'Adicionar Novo Post'"
    ></div>
    <div class="card-body">
      <form @submit.prevent="salvarPost">
        <div class="mb-3">
          <label class="form-label">Título</label>
          <input
            type="text"
            class="form-control"
            x-model="editPost.titulo"
            required
          />
        </div>
        <div class="mb-3">
          <label class="form-label"
            >Conteúdo (Cole um link para gerar um preview)</label
          >
          <textarea
            x-ref="conteudo"
            class="form-control"
            rows="8"
            x-model="editPost.conteudo_md"
            @paste="handlePaste($event)"
          ></textarea>
        </div>
        <div class="d-flex justify-content-end">
          <button
            type="button"
            class="btn btn-secondary me-2"
            x-show="editPost.id"
            @click="resetForm()"
          >
            Cancelar Edição
          </button>
          <button
            type="submit"
            class="btn btn-success"
            x-text="editPost.id ? 'Salvar Alterações' : 'Criar Post'"
          ></button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header fw-bold">Posts Existentes</div>
    <div class="card-body">
      <div class="table-responsive" style="max-height: 65vh; overflow-y: auto">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Título</th>
              <th>Status</th>
              <th>Publicado em</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for p in posts %}
            <tr>
              <td>{{ p.titulo }}</td>
              <td>
                <span
                  class="badge {{ 'bg-success' if p.status == 'publicado' else 'bg-secondary' }}"
                  >{{ p.status }}</span
                >
              </td>
              <td>{{ p.publicado_em.strftime('%d/%m/%Y %H:%M') }}</td>
              <td class="text-center">
                <button
                  class="btn btn-sm btn-outline-secondary"
                  @click="editarPost($event)"
                  data-id="{{ p.id }}"
                  data-titulo="{{ p.titulo | e }}"
                  data-conteudo="{{ p.conteudo_md | e }}"
                >
                  <i class="bi bi-pencil"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-danger"
                  @click="removerPost({{ p.id }})"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if pagination and (pagination.pages > 1) %}
        <nav aria-label="Paginação de posts">
          <ul class="pagination justify-content-center">
            <li
              class="page-item {% if not pagination.has_prev %}disabled{% endif %}"
            >
              <a
                class="page-link"
                href="{{ url_for('newsletter.admin_page', page=pagination.prev_num) if pagination.has_prev else '#' }}"
                tabindex="-1"
                >Anterior</a
              >
            </li>
            {% for pagenum in range(1, pagination.pages + 1) %}
            <li
              class="page-item {% if pagenum == pagination.page %}active{% endif %}"
            >
              <a
                class="page-link"
                href="{{ url_for('newsletter.admin_page', page=pagenum) }}"
                >{{ pagenum }}</a
              >
            </li>
            {% endfor %}
            <li
              class="page-item {% if not pagination.has_next %}disabled{% endif %}"
            >
              <a
                class="page-link"
                href="{{ url_for('newsletter.admin_page', page=pagination.next_num) if pagination.has_next else '#' }}"
                >Próxima</a
              >
            </li>
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block page_scripts %}
<script>
  function gerenciarNewsletter() {
    return {
      editPost: { id: null, titulo: "", conteudo_md: "" },

      resetForm() {
        this.editPost = { id: null, titulo: "", conteudo_md: "" };
      },

      async salvarPost() {
        const url = this.editPost.id
          ? `/api/news/post/${this.editPost.id}`
          : "/api/news/post";
        const method = this.editPost.id ? "PATCH" : "POST";

        const response = await fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            titulo: this.editPost.titulo,
            conteudo_md: this.editPost.conteudo_md,
            status: "publicado",
          }),
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert("Ocorreu um erro ao salvar o post.");
        }
      },

      editarPost(e) {
        const btn = e.currentTarget;
        const id = parseInt(btn.dataset.id, 10);
        const titulo = btn.dataset.titulo || "";
        const conteudo = btn.dataset.conteudo || "";
        this.editPost = { id, titulo, conteudo_md: conteudo };
        window.scrollTo({ top: 0, behavior: "smooth" });
      },

      async removerPost(id) {
        if (confirm("Tem a certeza de que deseja remover este post?")) {
          const response = await fetch(`/api/news/post/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            window.location.reload();
          } else {
            alert("Ocorreu um erro ao remover o post.");
          }
        }
      },

      async handlePaste(event) {
        event.preventDefault();
        const pastedText = (
          event.clipboardData || window.clipboardData
        ).getData("text");
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const urls = pastedText.match(urlRegex);

        // ---> INÍCIO DA NOVA LÓGICA <---
        // Se o que foi colado é um código de incorporação do Instagram
        if (pastedText.includes("instagram-media")) {
          // Adiciona o script de embed do Instagram se ainda não estiver lá
          let embedCode = pastedText;
          if (!embedCode.includes("www.instagram.com/embed.js")) {
            embedCode +=
              '<script async src="//www.instagram.com/embed.js"><\/script>';
          }
          this.insertTextAtCursor(embedCode);
          return; // Termina a execução aqui
        }
        // ---> FIM DA NOVA LÓGICA <---

        if (pastedText.trim().startsWith("<iframe")) {
          this.insertTextAtCursor(pastedText);
          return;
        }

        if (urls && urls.length > 0) {
          const url = urls[0];
          try {
            const response = await fetch(
              `/api/news/url_preview?url=${encodeURIComponent(url)}`
            );
            if (!response.ok) throw new Error("API request failed");

            const data = await response.json();
            let previewHtml = "";

            if (data.url.includes("drive.google.com")) {
              previewHtml = `<div class="ratio ratio-4x3 my-2"><iframe src="${data.url.replace(
                "/view",
                "/preview"
              )}" allow="autoplay"></iframe></div>`;
            } else if (data.image && data.title) {
              previewHtml = `
                            <div class="card my-3 text-start">
                                <a href="${
                                  data.url
                                }" target="_blank" class="text-decoration-none text-dark" style="display: block;">
                                    <div style="position: relative; background-color: #f8f9fa; text-align: center;">
                                        <img src="${
                                          data.image
                                        }" class="card-img-top" alt="Preview" style="max-height: 400px; width: 100%; object-fit: contain;">
                                    </div>
                                    <div class="card-body">
                                        <h6 class="card-title" style="font-weight: bold;">${
                                          data.title
                                        }</h6>
                                        <p class="card-text small text-muted" style="max-height: 3.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${
                                          data.description || ""
                                        }</p>
                                        <p class="card-text mb-0"><small class="text-muted">${
                                          data.site_name ||
                                          new URL(data.url).hostname
                                        }</small></p>
                                    </div>
                                </a>
                            </div>`;
            }

            if (previewHtml) {
              this.insertTextAtCursor(pastedText.replace(url, previewHtml));
            } else {
              this.insertTextAtCursor(pastedText);
            }
          } catch (error) {
            this.insertTextAtCursor(pastedText);
          }
        } else {
          this.insertTextAtCursor(pastedText);
        }
      },

      // Função auxiliar para inserir o texto na posição do cursor
      insertTextAtCursor(text) {
        const textarea = this.$refs.conteudo;
        const current = this.editPost.conteudo_md || "";
        if (!textarea) {
          this.editPost.conteudo_md = current + text;
          return;
        }
        const start = textarea.selectionStart ?? current.length;
        const end = textarea.selectionEnd ?? current.length;
        this.editPost.conteudo_md =
          current.slice(0, start) + text + current.slice(end);
        this.$nextTick(() => {
          textarea.selectionStart = textarea.selectionEnd = start + text.length;
          textarea.focus();
        });
      },
    };
  }
</script>
{% endblock %}
