{% extends 'base.html' %} {% block content %}
<div class="container p-4" x-data="gerenciarNewsletter()">
  <h1 class="mb-4">Admin Newsletter</h1>

  <div class="card mb-4">
    <div
      class="card-header fw-bold"
      x-text="editPost.id ? 'Editar Post' : 'Adicionar Novo Post'"
    ></div>
    <div class="card-body">
      <form @submit.prevent="salvarPost">
        <div class="mb-3">
          <label class="form-label">Título</label>
          <input
            type="text"
            class="form-control"
            x-model="editPost.titulo"
            required
          />
        </div>
        <div class="mb-3">
          <label class="form-label"
            >Conteúdo (Cole um link para gerar um preview)</label
          >
          <textarea
            x-ref="conteudo"
            class="form-control"
            rows="8"
            x-model="editPost.conteudo_md"
            @paste="handlePaste($event)"
          ></textarea>
        </div>
        <div class="d-flex justify-content-end">
          <button
            type="button"
            class="btn btn-secondary me-2"
            x-show="editPost.id"
            @click="resetForm()"
          >
            Cancelar Edição
          </button>
          <button
            type="submit"
            class="btn btn-success"
            x-text="editPost.id ? 'Salvar Alterações' : 'Criar Post'"
          ></button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header fw-bold">Posts Existentes</div>
    <div class="card-body">
      <div id="admin-news-posts">
        {% include 'admin/_newsletter_posts_list.html' %}
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação de Remoção -->
  <div class="modal fade" id="confirmRemovePostModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Remover Post</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza de que deseja remover o post:</p>
          <p class="mb-0"><strong x-text="deletePost.titulo || ''"></strong></p>
          <p class="text-danger small mt-2">Esta ação é permanente e removerá comentários e reações associados.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" @click="removerPostConfirmado()">Remover</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block page_scripts %}
<script>
  function gerenciarNewsletter() {
    return {
      init() {
        // Intercepta cliques na paginação para comportamento SPA
        this.$root.addEventListener("click", (ev) => {
          const link = ev.target.closest(".pagination a.page-link");
          if (!link) return;
          const href = link.getAttribute("href") || "";
          if (!href) return;
          const u = new URL(href, window.location.origin);
          const page = parseInt(u.searchParams.get("page") || "1", 10);
          ev.preventDefault();
          this.reloadList(page, true);
        });
        // Lida com voltar/avançar do navegador
        window.addEventListener("popstate", () => {
          this.reloadList(this.currentPage(), false);
        });
      },
      editPost: { id: null, titulo: "", conteudo_md: "" },
      deletePost: { id: null, titulo: "" },
      confirmRemoveModal: null,

      resetForm() {
        this.editPost = { id: null, titulo: "", conteudo_md: "" };
      },

      async salvarPost() {
        const isEdit = !!this.editPost.id;
        const url = this.editPost.id
          ? `/api/news/post/${this.editPost.id}`
          : "/api/news/post";
        const method = isEdit ? "PATCH" : "POST";

        const response = await fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            titulo: this.editPost.titulo,
            conteudo_md: this.editPost.conteudo_md,
            status: "publicado",
          }),
        });

        if (response.ok) {
          const current = this.currentPage();
          this.resetForm();
          if (isEdit) {
            this.reloadList(current, false);
          } else {
            this.reloadList(1, true);
          }
        } else {
          alert("Ocorreu um erro ao salvar o post.");
        }
      },

      editarPost(e) {
        const btn = e.currentTarget;
        const id = parseInt(btn.dataset.id, 10);
        const titulo = btn.dataset.titulo || "";
        const conteudo = btn.dataset.conteudo || "";
        this.editPost = { id, titulo, conteudo_md: conteudo };
        window.scrollTo({ top: 0, behavior: "smooth" });
      },

      confirmarRemocao(id, titulo) {
        this.deletePost = { id, titulo };
        if (!this.confirmRemoveModal) {
          this.confirmRemoveModal = new bootstrap.Modal(
            document.getElementById('confirmRemovePostModal')
          );
        }
        this.confirmRemoveModal.show();
      },

      async removerPostConfirmado() {
        if (!this.deletePost.id) return;
        const id = this.deletePost.id;
        const response = await fetch(`/api/news/post/${id}`, { method: 'DELETE' });
        if (response.ok) {
          this.confirmRemoveModal?.hide();
          const current = this.currentPage();
          this.reloadList(current, false);
          this.deletePost = { id: null, titulo: '' };
        } else {
          alert('Ocorreu um erro ao remover o post.');
        }
      },

      async handlePaste(event) {
        event.preventDefault();
        const pastedText = (
          event.clipboardData || window.clipboardData
        ).getData("text");
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const urls = pastedText.match(urlRegex);

        // ---> INÍCIO DA NOVA LÓGICA <---
        // Se o que foi colado é um código de incorporação do Instagram
        if (pastedText.includes("instagram-media")) {
          // Adiciona o script de embed do Instagram se ainda não estiver lá
          let embedCode = pastedText;
          if (!embedCode.includes("www.instagram.com/embed.js")) {
            embedCode +=
              '<script async src="//www.instagram.com/embed.js"><\/script>';
          }
          this.insertTextAtCursor(embedCode);
          return; // Termina a execução aqui
        }
        // ---> FIM DA NOVA LÓGICA <---

        if (pastedText.trim().startsWith("<iframe")) {
          this.insertTextAtCursor(pastedText);
          return;
        }

        if (urls && urls.length > 0) {
          const url = urls[0];
          try {
            const response = await fetch(
              `/api/news/url_preview?url=${encodeURIComponent(url)}`
            );
            if (!response.ok) throw new Error("API request failed");

            const data = await response.json();
            let previewHtml = "";

            if (data.url.includes("drive.google.com")) {
              previewHtml = `<div class="ratio ratio-4x3 my-2"><iframe src="${data.url.replace(
                "/view",
                "/preview"
              )}" allow="autoplay"></iframe></div>`;
            } else if (data.image && data.title) {
              previewHtml = `
                            <div class="card my-3 text-start">
                                <a href="${
                                  data.url
                                }" target="_blank" class="text-decoration-none text-dark" style="display: block;">
                                    <div style="position: relative; background-color: #f8f9fa; text-align: center;">
                                        <img src="${
                                          data.image
                                        }" class="card-img-top" alt="Preview" style="max-height: 400px; width: 100%; object-fit: contain;">
                                    </div>
                                    <div class="card-body">
                                        <h6 class="card-title" style="font-weight: bold;">${
                                          data.title
                                        }</h6>
                                        <p class="card-text small text-muted" style="max-height: 3.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${
                                          data.description || ""
                                        }</p>
                                        <p class="card-text mb-0"><small class="text-muted">${
                                          data.site_name ||
                                          new URL(data.url).hostname
                                        }</small></p>
                                    </div>
                                </a>
                            </div>`;
            }

            if (previewHtml) {
              this.insertTextAtCursor(pastedText.replace(url, previewHtml));
            } else {
              this.insertTextAtCursor(pastedText);
            }
          } catch (error) {
            this.insertTextAtCursor(pastedText);
          }
        } else {
          this.insertTextAtCursor(pastedText);
        }
      },

      // Função auxiliar para inserir o texto na posição do cursor
      insertTextAtCursor(text) {
        const textarea = this.$refs.conteudo;
        const current = this.editPost.conteudo_md || "";
        if (!textarea) {
          this.editPost.conteudo_md = current + text;
          return;
        }
        const start = textarea.selectionStart ?? current.length;
        const end = textarea.selectionEnd ?? current.length;
        this.editPost.conteudo_md =
          current.slice(0, start) + text + current.slice(end);
        this.$nextTick(() => {
          textarea.selectionStart = textarea.selectionEnd = start + text.length;
          textarea.focus();
        });
      },

      // Página atual a partir da URL
      currentPage() {
        const params = new URLSearchParams(window.location.search);
        const p = parseInt(params.get("page") || "1", 10);
        return isNaN(p) || p < 1 ? 1 : p;
      },

      // Recarrega a lista via fetch + troca de HTML; opcionalmente atualiza a URL
      reloadList(page = null, pushUrl = false) {
        const p = page ?? this.currentPage();
        const targetSel = "#admin-news-posts";
        const url = `${window.location.pathname}?_partial=1&page=${p}`;
        fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
          .then((r) => r.text())
          .then((html) => {
            const target = document.querySelector(targetSel);
            if (target) target.innerHTML = html;
            if (pushUrl) {
              const newUrl = `${window.location.pathname}?page=${p}`;
              window.history.pushState({}, "", newUrl);
            }
          });
      },
    };
  }
</script>
{% endblock %}
