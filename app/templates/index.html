{% extends "base.html" %}

{% block content %}
<div x-data="dashboard">
  <div class="row mb-4 align-items-center">
    <div class="col-lg-7">
      <div style="position: relative; min-height: 70px;" class="d-flex align-items-center">
        <img src="{{ url_for('static', filename='img/logo_nova.png') }}" alt="Intranet Auvo" 
             style="position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 185px; height: auto;">
        <div class="totalizador-pill" style="margin-left: 205px;">
            <span>Já somos </span>
            <span x-text="count" class="mx-1 fw-bold"></span>
            <span>Auvolovers</span>
            <i class="bi bi-heart-fill ms-2" style="color: var(--auvo-lilas);"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card card-link-externo card-instagram h-100">
        <div class="card-body d-flex justify-content-between align-items-center p-3">
          <div>
            <h6 class="card-title mb-1"><i class="bi bi-instagram"></i>Siga o Auvo Talentos</h6>
            <p class="card-text small text-muted mb-0">Acompanhe nossa cultura, iniciativas e o dia a dia do time Auvo.</p>
          </div>
          <a href="https://www.instagram.com/auvotalentos/" target="_blank" class="btn btn-sm btn-instagram btn-card-action">@auvotalentos</a>
        </div>
      </div>
    </div>
  </div>


  <div class="row">
    <div class="col-lg-7">
      <div class="card card-comunicados mb-4">
        <div class="card-header bg-transparent">
          <h5 class="card-title mb-0"><i class="bi bi-megaphone-fill me-2" style="color: var(--auvo-verde);"></i> Comunicados Importantes</h5>
        </div>
        <div class="card-body p-0 custom-scrollbar" style="max-height: 250px; overflow-y: auto;">
          <div class="list-group list-group-flush">
            {% if avisos %}
              {% for aviso in avisos %}
              <a href="#" @click.prevent='openAvisoModal({{ aviso|tojson|safe }})' class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1 fw-bold small">{{ aviso.titulo }}</h6>
                  <small class="text-muted">{{ aviso.data_criacao_fmt }}</small>
                </div>
                <p class="mb-1 text-muted small">{{ aviso.conteudo|truncate(80) }}</p>
              </a>
              {% endfor %}
            {% else %}
              <p class="text-muted text-center p-3 small">Nenhum comunicado recente.</p>
            {% endif %}
          </div>
        </div>
      </div>
      
      <div class="card card-destaque mb-4">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0 text-white">
              <i class="bi bi-star-fill" style="color: var(--auvo-lilas);"></i> 
              Destaques de {{ nome_mes_destaque }}
          </h5>
        </div>
        <div class="card-body text-center pt-2">
          {% if destaques %}
            <div id="carouselDestaques" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              {% for destaque in destaques %}
              <div class="carousel-item {{ 'active' if loop.first else '' }}">
                {% set imagem_destaque = destaque.imagem_filename %}
                {% set foto_colaborador = destaque.colaborador.foto_filename %}
                {% if imagem_destaque %}
                    {% set imagem_final = 'fotos_colaboradores/' + imagem_destaque %}
                {% elif foto_colaborador %}
                    {% set imagem_final = 'fotos_colaboradores/' + foto_colaborador %}
                {% else %}
                    {% set imagem_final = 'img/default_avatar.png' %}
                {% endif %}
                <img src="{{ url_for('static', filename=imagem_final) }}" class="img-fluid rounded mb-3" style="max-height: 350px;" alt="Destaque do Mês">
                <h5 class="fw-bold mb-1">{{ destaque.titulo }}</h5>
                <h6 class="mb-2">{{ destaque.colaborador.nome }} {{ destaque.colaborador.sobrenome }}</h6>
                <p class="text-white-50 fst-italic">“{{ destaque.descricao or 'Destaque do Mês!' }}”</p>
              </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselDestaques" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselDestaques" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-star-fill fs-1 text-white-50"></i>
            <h6 class="mt-3">Nenhum destaque para {{ nome_mes_destaque }}</h6>
            <p class="text-white-50 small">Aguardando os talentos brilharem!</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card card-ouvidoria mb-4">
        <div class="card-body d-flex justify-content-between align-items-center p-3">
          <div class="d-flex align-items-center">
            <i class="bi bi-chat-quote-fill fs-3 me-3" style="color: var(--auvo-verde);"></i>
            <div>
              <h6 class="card-title mb-1">Canal de Ouvidoria</h6>
              <p class="card-text small text-muted mb-0">Envie sugestões, críticas ou denúncias de forma segura e confidencial.</p>
            </div>
          </div>
          <a href="{{ url_for('main.ouvidoria') }}" class="btn btn-sm btn-ouvidoria btn-card-action">Enviar</a>
        </div>
      </div>
      <div class="card card-eventos mb-4">
        <div class="card-header bg-transparent">
            <h5 class="card-title mb-0"><i class="bi bi-calendar-event-fill me-2" style="color: var(--auvo-lilas);"></i> Próximos Eventos</h5>
        </div>
        <div class="card-body p-0 custom-scrollbar" style="max-height: 250px; overflow-y: auto;">
            <ul class="list-group list-group-flush">
                {% if eventos %}
                {% for evento in eventos %}
                <li class="list-group-item list-group-item-action d-flex align-items-center" @click='openEventoModal({{ evento|tojson|safe }})' style="cursor: pointer;">
                  <div class="evento-data">
                      <span class="fw-bold">{{ evento.start|datetimeformat('%d') }}</span>
                      <small>{{ evento.start|datetimeformat('%b')|upper }}</small>
                  </div>
                  <div class="ms-3">
                      <h6 class="fw-bold mb-0 small">{{ evento.title }}</h6>
                  </div>
                </li>
                {% endfor %}
                {% else %}
                <li class="list-group-item">
                  <p class="text-muted text-center p-3 small mb-0">Nenhum evento agendado.</p>
                </li>
                {% endif %}
            </ul>
        </div>
      </div>

      <div class="card card-aniversariantes mb-4">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0"><i class="bi bi-cake2-fill me-2" style="color: var(--auvo-lilas);"></i> Aniversariantes do Mês</h5>
        </div>
        <div class="card-body custom-scrollbar" style="max-height: 350px; overflow-y: auto;">
          {% if aniversariantes %}
          <ul class="list-group list-group-flush">
            {% for aniversariante in aniversariantes %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                {% if aniversariante.foto_filename %}
                    <img src="{{ url_for('static', filename='fotos_colaboradores/' + aniversariante.foto_filename) }}" class="aniversariante-avatar" alt="Foto">
                {% else %}
                    <img src="{{ url_for('static', filename='img/default_avatar.png') }}" class="aniversariante-avatar" alt="Avatar Padrão">
                {% endif %}
                <div class="ms-2 lh-1">
                    <div class="fw-bold">{{ aniversariante.nome }} {{ aniversariante.sobrenome }}</div>
                    <small class="text-muted">{{ aniversariante.cargo or '' }}</small>
                </div>
              </div>
              <span class="badge bg-light text-dark">{{ aniversariante.data_nascimento.strftime('%d/%m') }}</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted text-center mt-3">Nenhum aniversariante este mês.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalLabel" x-text="modalData.title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" x-html="modalData.content"></div>
        <div class="modal-footer d-flex justify-content-between align-items-center">
            <small class="text-muted" x-text="modalData.footer"></small>
            <div>
              <template x-if="modalData.link_url">
                  <a :href="modalData.link_url" target="_blank" class="btn btn-primary" x-text="modalData.link_texto"></a>
              </template>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block page_scripts %}
<script>
  window._totalColaboradores = {{ total_colaboradores or 0 }};
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock page_scripts %}